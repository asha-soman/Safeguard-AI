<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePrompt - Prompt Injection Risk Analyzer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        body {
            background: linear-gradient(135deg, #8e9ee6 0%, #a16cd6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .risk-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
        }

        .risk-low {
            background-color: #28a745;
        }

        .risk-medium {
            background-color: #ffc107;
            color: #000;
        }

        .risk-high {
            background-color: #dc3545;
        }

        .comparison-section {
            display: none;
        }

        .loading {
            display: none;
        }

        .code-block {
            background-color: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .hero-section {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 40px;
            font-size: 1.1rem;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .suspicious-highlight {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="display-4 mb-3"> SafeGuard AI</h1>
            <p class="lead">Analyze and secure your AI prompts against injection attacks</p>
        </div>

        <!-- Input Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Enter Your Prompt</h5>

                <div class="mb-3">
                    <textarea class="form-control" id="promptInput" rows="6"
                        placeholder="Paste your prompt here to analyze for security risks..."></textarea>
                </div>

                <button class="btn btn-primary btn-analyze" onclick="analyzePrompt()">
                    Analyze Prompt
                </button>

                <!-- Clarification Section (hidden by default) -->
                <div id="clarificationSection" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Claude needs more context:</strong>
                        <p id="clarificationQuestion" class="mb-2"></p>
                        <label for="clarificationInput" class="form-label">Your answer</label>
                        <textarea class="form-control" id="clarificationInput" rows="3"
                            placeholder="Provide more context so the model can judge your intent more accurately..."></textarea>
                        <button class="btn btn-outline-primary mt-2" onclick="submitClarificationAndAnalyze()">
                            Submit clarification & analyze
                        </button>
                    </div>
                </div>


                <!-- Loading Spinner -->
                <div class="loading mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Analyzing your prompt...</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="comparison-section" id="resultsSection">
            <!-- Risk Overview -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Analysis Results</h5>

                    <div class="mb-4">
                        <span class="badge risk-badge" id="riskBadge">Low</span>
                    </div>

                    <div class="mb-4">
                        <h6>Category:</h6>
                        <span class="badge bg-secondary fs-6 p-2" id="categoryBadge">Benign</span>
                    </div>

                    <div class="mb-4">
                        <h6>Reasons:</h6>
                        <ul id="reasonsList" class="list-group">
                            <!-- Reasons will be populated here -->
                        </ul>
                    </div>

                    <div>
                        <h6>Suspicious Phrases:</h6>
                        <div id="suspiciousPhrases" class="alert alert-warning">
                            <!-- Suspicious phrases will be highlighted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script>
        async function analyzePrompt() {
        const prompt = document.getElementById('promptInput').value.trim();
        if (!prompt) {
            alert('Please enter a prompt to analyze');
            return;
        }

        const clarificationSection = document.getElementById('clarificationSection');
        const clarificationInput = document.getElementById('clarificationInput');
        const clarification = clarificationInput ? clarificationInput.value.trim() : "";

        // If clarification section is visible and user has entered clarification,
        // go straight to /analyze with both prompt + clarification
        if (clarificationSection.style.display !== 'none' && clarification) {
            await callAnalyzeApi(prompt, clarification);
            return;
        }

        // Otherwise, first ask Claude if it needs clarification
        await callClarifyApi(prompt);
    }

    async function callClarifyApi(prompt) {
        // Show loading, hide results & clarification section
        document.querySelector('.loading').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        const clarificationSection = document.getElementById('clarificationSection');
        clarificationSection.style.display = 'none';

        try {
            const response = await fetch('/clarify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                let errMsg = 'Clarification check failed';
                try {
                    const errData = await response.json();
                    if (errData && errData.detail) {
                        errMsg = errData.detail;
                    }
                } catch (e) {
                    // ignore
                }
                throw new Error(errMsg);
            }

            const data = await response.json();

            if (data.needs_clarification) {
                // Show question to user
                const questionEl = document.getElementById('clarificationQuestion');
                const clarificationInput = document.getElementById('clarificationInput');
                questionEl.textContent = data.question || "Please provide more context for your prompt.";
                clarificationInput.value = "";
                clarificationSection.style.display = 'block';
                // Stop here; wait for user to click "Submit clarification & analyze"
            } else {
                // No clarification needed â†’ go straight to analysis
                await callAnalyzeApi(prompt, "");
            }

        } catch (error) {
            alert('Error during clarification: ' + error.message);
            console.error(error);
        } finally {
            document.querySelector('.loading').style.display = 'none';
        }
    }

    async function callAnalyzeApi(prompt, clarification) {
        // Show loading, hide clarification section while analyzing
        document.querySelector('.loading').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    clarification: clarification || null
                })
            });

            if (!response.ok) {
                let errMsg = 'Analysis failed';
                try {
                    const errData = await response.json();
                    if (errData && errData.detail) {
                        errMsg = errData.detail;
                    }
                } catch (e) {
                    // ignore
                }
                throw new Error(errMsg);
            }

            const data = await response.json();
            displayResults(data, prompt);

        } catch (error) {
            alert('Error analyzing prompt: ' + error.message);
            console.error(error);
        } finally {
            document.querySelector('.loading').style.display = 'none';
        }
    }

    function submitClarificationAndAnalyze() {
        // Called when user clicks "Submit clarification & analyze" button
        analyzePrompt();
    }

        function displayResults(data, originalPrompt) {
            // Update risk badge
            const riskBadge = document.getElementById('riskBadge');
            riskBadge.textContent = data.risk_level;
            riskBadge.className = 'badge risk-badge risk-' + data.risk_level.toLowerCase();

            // Update category badge
            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = data.category;

            // Color code category
            if (data.category === 'Benign') {
                categoryBadge.className = 'badge bg-success fs-6 p-2';
            } else if (data.category === 'Prompt Injection') {
                categoryBadge.className = 'badge bg-danger fs-6 p-2';
            } else if (data.category === 'Data Exfiltration') {
                categoryBadge.className = 'badge bg-warning text-dark fs-6 p-2';
            }

            // Update reasons list
            const reasonsList = document.getElementById('reasonsList');
            reasonsList.innerHTML = '';
            data.reasons.forEach(reason => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = reason;
                reasonsList.appendChild(li);
            });

            // Update suspicious phrases with highlighting
            const suspiciousPhrasesDiv = document.getElementById('suspiciousPhrases');
            if (data.suspicious_phrases.length === 0) {
                suspiciousPhrasesDiv.innerHTML = '<p class="mb-0 text-success"> No suspicious phrases detected</p>';
                suspiciousPhrasesDiv.className = 'alert alert-success';
            } else {
                suspiciousPhrasesDiv.className = 'alert alert-warning';
                suspiciousPhrasesDiv.innerHTML = '<p class="mb-2"><strong>Detected suspicious phrases:</strong></p>';
                data.suspicious_phrases.forEach(phrase => {
                    const span = document.createElement('span');
                    span.className = 'suspicious-highlight';
                    span.textContent = phrase;
                    suspiciousPhrasesDiv.appendChild(span);
                    suspiciousPhrasesDiv.appendChild(document.createTextNode(' '));
                });
            }

            // Show results
            document.getElementById('resultsSection').style.display = 'block';

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Allow Enter key to submit (with Ctrl/Cmd)
        document.getElementById('promptInput').addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                analyzePrompt();
            }
        });
    </script>
</body>

</html>